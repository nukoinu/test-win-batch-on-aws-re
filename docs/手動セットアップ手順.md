# AWS CodeBuild & ECS Windows バッチ処理 手動セットアップ手順

## 概要
このドキュメントでは、AWS CodeBuild と ECS を使用してWindows コンテナでバッチ処理を実行するための環境を手動で構築する手順を説明します。

## 前提条件
- AWS CLI がインストール・設定済み
- 適切な AWS 権限を持つユーザーでログイン済み
- Docker Desktop for Windows がインストール済み（ローカルテスト用）

## 環境変数設定
```powershell
$ACCOUNT_ID = "あなたのAWSアカウントID"
$REGION = "ap-northeast-1"
$REPOSITORY_NAME = "countdown-test"
$CLUSTER_NAME = "windows-batch-test-cluster"
$PROJECT_NAME = "windows-countdown-build"
```

## 手順1: ECRリポジトリの作成

```powershell
# ECRリポジトリ作成
aws ecr create-repository --repository-name $REPOSITORY_NAME --region $REGION

# 作成確認
aws ecr describe-repositories --repository-names $REPOSITORY_NAME --region $REGION
```

## 手順2: CloudWatch Logs グループ作成

```powershell
# ECS用ロググループ
aws logs create-log-group --log-group-name "/ecs/countdown-test" --region $REGION

# CodeBuild用ロググループ  
aws logs create-log-group --log-group-name "/aws/codebuild/windows-countdown-build" --region $REGION

# 作成確認
aws logs describe-log-groups --log-group-name-prefix "/ecs/" --region $REGION
aws logs describe-log-groups --log-group-name-prefix "/aws/codebuild/" --region $REGION
```

## 手順3: IAMロールの作成

### 3.1 CodeBuild サービスロール

```powershell
# 信頼ポリシーファイル作成
@"
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "codebuild.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
"@ | Out-File -FilePath "codebuild-trust-policy.json" -Encoding UTF8

# ロール作成
aws iam create-role --role-name "codebuild-windows-countdown-service-role" --assume-role-policy-document file://codebuild-trust-policy.json

# ポリシー内容を編集（codebuild\codebuild-service-role-policy.json の ACCOUNT_ID を置換）
$policyContent = Get-Content "codebuild\codebuild-service-role-policy.json" -Raw
$policyContent = $policyContent -replace "ACCOUNT_ID", $ACCOUNT_ID
$policyContent | Out-File -FilePath "codebuild-service-role-policy-updated.json" -Encoding UTF8

# ポリシーをアタッチ
aws iam put-role-policy --role-name "codebuild-windows-countdown-service-role" --policy-name "CodeBuildServiceRolePolicy" --policy-document file://codebuild-service-role-policy-updated.json
```

### 3.2 ECS Task Execution Role

```powershell
# ecsTaskExecutionRole が存在するか確認
aws iam get-role --role-name ecsTaskExecutionRole

# 存在しない場合は作成
@"
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "ecs-tasks.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
"@ | Out-File -FilePath "ecs-task-trust-policy.json" -Encoding UTF8

aws iam create-role --role-name "ecsTaskExecutionRole" --assume-role-policy-document file://ecs-task-trust-policy.json
aws iam attach-role-policy --role-name "ecsTaskExecutionRole" --policy-arn "arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy"
```

## 手順4: 設定ファイルの更新

### 4.1 CodeBuild プロジェクト設定更新

```powershell
# プロジェクト設定ファイルを編集
$projectConfig = Get-Content "codebuild\project.json" -Raw
$projectConfig = $projectConfig -replace "ACCOUNT_ID", $ACCOUNT_ID
$projectConfig = $projectConfig -replace "countdown-test", $REPOSITORY_NAME
$projectConfig | Out-File -FilePath "codebuild\project-updated.json" -Encoding UTF8
```

### 4.2 ECS タスク定義更新

```powershell
# タスク定義ファイルを編集
$taskDefinition = Get-Content "ecs\task-definition.json" -Raw
$taskDefinition = $taskDefinition -replace "ACCOUNT_ID", $ACCOUNT_ID
$taskDefinition = $taskDefinition -replace "countdown-test", $REPOSITORY_NAME
$taskDefinition | Out-File -FilePath "ecs\task-definition-updated.json" -Encoding UTF8
```

## 手順5: CodeBuild プロジェクト作成

```powershell
# プロジェクト作成
aws codebuild create-project --cli-input-json file://codebuild/project-updated.json --region $REGION

# 作成確認
aws codebuild batch-get-projects --names $PROJECT_NAME --region $REGION
```

## 手順6: ECS クラスタ作成

```powershell
# クラスタ作成
aws ecs create-cluster --cluster-name $CLUSTER_NAME --region $REGION

# 作成確認
aws ecs describe-clusters --clusters $CLUSTER_NAME --region $REGION
```

## 手順7: ローカルでのイメージビルドとテスト（オプション）

```powershell
# execution ディレクトリに移動
cd execution

# イメージビルド
docker build -t countdown-test .

# ローカルテスト実行
docker run --rm countdown-test
```

## 手順8: CodeBuild での実行

```powershell
# ビルド実行
aws codebuild start-build --project-name $PROJECT_NAME --region $REGION

# ビルド状況確認
aws codebuild list-builds-for-project --project-name $PROJECT_NAME --region $REGION
```

## 手順9: ECS タスク定義登録とタスク実行

```powershell
# タスク定義登録
aws ecs register-task-definition --cli-input-json file://ecs/task-definition-updated.json --region $REGION

# タスク実行
aws ecs run-task --cluster $CLUSTER_NAME --task-definition countdown-test --region $REGION

# タスク状況確認
aws ecs list-tasks --cluster $CLUSTER_NAME --region $REGION
aws ecs describe-tasks --cluster $CLUSTER_NAME --tasks <task-arn> --region $REGION
```

## 手順10: ログ確認

```powershell
# CodeBuild ログ
aws logs describe-log-streams --log-group-name "/aws/codebuild/windows-countdown-build" --region $REGION

# ECS ログ
aws logs describe-log-streams --log-group-name "/ecs/countdown-test" --region $REGION

# ログ内容表示
aws logs get-log-events --log-group-name "/ecs/countdown-test" --log-stream-name <log-stream-name> --region $REGION
```

## トラブルシューティング

### よくある問題と解決方法

1. **ECRリポジトリにプッシュできない**
   ```powershell
   # ECR ログイン
   aws ecr get-login-password --region $REGION | docker login --username AWS --password-stdin $ACCOUNT_ID.dkr.ecr.$REGION.amazonaws.com
   ```

2. **CodeBuild でビルドが失敗する**
   - IAMロールの権限を確認
   - buildspec.yml の構文を確認
   - CloudWatch Logs でエラー詳細を確認

3. **ECS タスクが起動しない**
   - タスク定義の CPU/メモリ設定を確認
   - セキュリティグループ・ネットワーク設定を確認
   - コンテナイメージが存在するか確認

4. **Windows コンテナ固有の問題**
   - Windows Server Core の バージョン互換性を確認
   - PowerShell スクリプトの実行ポリシーを確認

## リソース削除

### 手動削除手順
```powershell
# 作成したリソースを逆順で削除
aws ecs delete-cluster --cluster $CLUSTER_NAME --region $REGION
aws codebuild delete-project --name $PROJECT_NAME --region $REGION
aws iam delete-role-policy --role-name "codebuild-windows-countdown-service-role" --policy-name "CodeBuildServiceRolePolicy"
aws iam delete-role --role-name "codebuild-windows-countdown-service-role"
aws logs delete-log-group --log-group-name "/aws/codebuild/windows-countdown-build" --region $REGION
aws logs delete-log-group --log-group-name "/ecs/countdown-test" --region $REGION
aws ecr delete-repository --repository-name $REPOSITORY_NAME --region $REGION --force
```

### 自動削除ツール使用
```powershell
# リソース確認
.\cleanup-resources.ps1

# リソース削除（確認あり）
.\cleanup-resources.ps1 -Delete

# リソース削除（確認なし）
.\cleanup-resources.ps1 -Delete -Force
```

## 参考情報

- [AWS CodeBuild User Guide](https://docs.aws.amazon.com/codebuild/)
- [Amazon ECS Developer Guide](https://docs.aws.amazon.com/ecs/)
- [Amazon ECR User Guide](https://docs.aws.amazon.com/ecr/)
- [Windows containers on AWS](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/windows_containers.html)
