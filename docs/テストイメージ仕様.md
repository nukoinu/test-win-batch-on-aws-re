# テストイメージ仕様

## 概要
AWS Batch/ECS環境でのWindows実行ファイル多重起動検証を目的とした、Windows Server 2022ベースのDockerイメージ仕様。

## ベースイメージ
- **公式イメージ**: `mcr.microsoft.com/windows/server:ltsc2022`
- **OS**: Windows Server 2022 (Long-Term Servicing Channel)
- **提供元**: Microsoft Container Registry (MCR)

## イメージの目的
1. カウントダウンテスト実行ファイル (`countdown.exe`) の実行環境提供
2. AWS Batch/ECS環境での多重起動検証
3. Windows環境における長時間実行プロセスの安定性確認

## 技術仕様

### システム要件
- **CPU アーキテクチャ**: x86_64 (AMD64)
- **最小メモリ**: 512MB
- **最小ディスク容量**: 2GB
- **ネットワーク**: 基本的なインターネット接続（イメージプル時のみ）

### 含まれるコンポーネント
1. **Windows Server Core**
   - 最小限のWindows Server機能
   - PowerShell Core
   - 基本的なシステムユーティリティ

2. **テスト実行ファイル**
   - `countdown.exe` - C++で作成されたカウントダウンプログラム
   - 配置場所: `C:\app\countdown.exe`

3. **実行環境**
   - Visual C++ Redistributable（必要に応じて）
   - 標準的なWindows実行時ライブラリ

### イメージサイズ
- **予想サイズ**: 約2-3GB
- **最適化**: Multi-stage buildによる不要ファイルの除去

## Dockerfile構成

### マルチステージビルド構成
```dockerfile
# ステージ1: ビルド環境
FROM mcr.microsoft.com/windows/server:ltsc2022 as builder
# 必要に応じてビルドツールをインストール

# ステージ2: 実行環境
FROM mcr.microsoft.com/windows/server:ltsc2022 as runtime
# テスト実行ファイルのコピーと設定
```

### 主要な設定項目
1. **作業ディレクトリ**: `C:\app`
2. **実行ファイル配置**: `C:\app\countdown.exe`
3. **エントリーポイント**: PowerShellまたはCmd
4. **デフォルトコマンド**: 実行ファイルのヘルプ表示

## 使用方法

### 基本実行
```powershell
# 10秒カウントダウン
docker run --rm countdown-test:latest countdown.exe 10

# 300秒カウントダウン
docker run --rm countdown-test:latest countdown.exe 300
```

### AWS Batch/ECS環境での実行
```json
{
  "jobDefinition": {
    "type": "container",
    "platformCapabilities": ["EC2"],
    "containerProperties": {
      "image": "your-registry/countdown-test:latest",
      "vcpus": 1,
      "memory": 512,
      "jobRoleArn": "arn:aws:iam::account:role/BatchJobRole"
    }
  }
}
```

## 検証項目
このイメージを使用して以下の検証を実施：

### 1. 単一インスタンス検証
- 正常な起動・終了
- 適切なログ出力
- リソース使用量の確認

### 2. 多重起動検証
- 複数インスタンスの同時実行
- リソース競合の有無
- 各インスタンスの独立性確認

### 3. 長時間実行検証
- 長時間（数時間）の連続実行
- メモリリークの有無
- システムの安定性確認

### 4. エラーハンドリング検証
- 無効な引数に対する適切なエラー処理
- 異常終了時の動作確認

## 運用考慮事項

### セキュリティ
- 最新のセキュリティパッチ適用
- 最小限の権限で実行
- 不要なサービスの無効化

### モニタリング
- CloudWatch Logsによるログ収集
- メトリクス監視設定
- アラート設定

### パフォーマンス
- リソース使用量の最適化
- 起動時間の短縮
- イメージサイズの最小化

## 更新・保守
- 定期的なベースイメージの更新
- セキュリティパッチの適用
- テスト実行ファイルのバージョン管理

## 関連ドキュメント
- [テスト実行ファイル仕様](./テスト実行ファイル仕様.md)
- [AWS Batch設定ガイド](../README.md)
- test-exec/ フォルダ内のビルド関連ドキュメント